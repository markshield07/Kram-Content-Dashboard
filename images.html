<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator - ContentAI</title>
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-card: #141414;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #f7931a;
            --accent-hover: #ffa726;
            --border: #2a2a2a;
            --success: #34c759;
            --error: #ff3b30;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - same as other pages */
        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .sidebar-logo h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .sidebar-logo h1 span {
            color: var(--accent);
        }

        .nav-section {
            padding: 0 12px;
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 8px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(247, 147, 26, 0.1);
            color: var(--accent);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
        }

        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        /* Content Layout */
        .content-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: calc(100vh - 73px);
        }

        /* Generator Panel */
        .generator-panel {
            padding: 30px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(247, 147, 26, 0.05);
        }

        .upload-area.has-image {
            padding: 16px;
            border-style: solid;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: var(--text-secondary);
        }

        .upload-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .uploaded-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        /* Prompt Input */
        .prompt-section {
            margin-bottom: 24px;
        }

        .prompt-label {
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        .prompt-input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .prompt-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .prompt-input::placeholder {
            color: var(--text-secondary);
        }

        /* Style Presets */
        .style-presets {
            margin-bottom: 24px;
        }

        .presets-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .preset-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-card:hover {
            border-color: var(--accent);
        }

        .preset-card.selected {
            background: rgba(247, 147, 26, 0.1);
            border-color: var(--accent);
        }

        .preset-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .preset-name {
            font-size: 13px;
            font-weight: 500;
        }

        /* Options */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .option-group {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .option-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .option-select {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .option-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Generate Button */
        .generate-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .generate-btn:hover {
            background: var(--accent-hover);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Results Panel */
        .results-panel {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            padding: 30px;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .result-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .result-actions {
            padding: 12px;
            display: flex;
            gap: 8px;
        }

        .result-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result-btn:hover {
            border-color: var(--accent);
        }

        .result-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        /* Empty State */
        .empty-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-results svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-results h3 {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-results p {
            font-size: 14px;
        }

        /* Sample Prompts */
        .sample-prompts {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .sample-prompt {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sample-prompt:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-layout {
                grid-template-columns: 1fr;
            }

            .results-panel {
                border-left: none;
                border-top: 1px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }

            .presets-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <h1>Content<span>AI</span></h1>
        </div>

        <div class="nav-section">
            <a href="/dashboard" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Dashboard
            </a>
            <a href="/analytics" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 20V10"></path>
                    <path d="M12 20V4"></path>
                    <path d="M6 20v-6"></path>
                </svg>
                Analytics
            </a>
            <a href="/generate" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
                    <path d="M20 12a8 8 0 0 0-8-8v8h8z"></path>
                </svg>
                Generate Content
            </a>
            <a href="/images" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                Image Generator
            </a>
            <a href="/calendar" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Calendar
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Tools</div>
            <a href="/ab-testing" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <polyline points="17 11 19 13 23 9"></polyline>
                </svg>
                A/B Testing
            </a>
            <a href="/trends" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                Trends
            </a>
            <a href="/competitors" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Competitors
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Account</div>
            <a href="/settings" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Settings
            </a>
            <a href="/api/logout" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header class="top-header">
            <h1 class="page-title">Image Generator</h1>
        </header>

        <div class="content-layout">
            <!-- Generator Panel -->
            <div class="generator-panel">
                <h2 class="section-title">Reference Image</h2>
                <div class="upload-area has-image" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="handleFileUpload(event)">
                    <img src="/assets/mutant-ape/mutant_ape.png" class="uploaded-image" alt="KRAM's Mutant Ape" id="referencePreview">
                    <div class="upload-text" style="margin-top: 12px;">Your Mutant Ape (auto-loaded) — click to use a different image</div>
                    <div class="upload-hint">The server always references your Mutant Ape for GPT-4o analysis</div>
                </div>

                <div class="prompt-section">
                    <label class="prompt-label">Describe the scene / background</label>
                    <textarea
                        class="prompt-input"
                        id="promptInput"
                        placeholder="Describe the background/scene you want your Mutant Ape in. E.g. 'cozy coffee shop with morning light' or 'Tokyo neon cityscape at night with rain reflections'..."
                    ></textarea>
                </div>

                <div class="style-presets">
                    <h3 class="section-title">Art Style</h3>
                    <div class="presets-grid">
                        <div class="preset-card selected" onclick="selectPreset(this, 'realistic')">
                            <div class="preset-icon">&#127909;</div>
                            <div class="preset-name">Cinematic 3D</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'anime')">
                            <div class="preset-icon">&#127912;</div>
                            <div class="preset-name">Anime</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'cyberpunk')">
                            <div class="preset-icon">&#129302;</div>
                            <div class="preset-name">Cyberpunk</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'pixel')">
                            <div class="preset-icon">&#128126;</div>
                            <div class="preset-name">Pixel Art</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'watercolor')">
                            <div class="preset-icon">&#127912;</div>
                            <div class="preset-name">Watercolor</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'oil_painting')">
                            <div class="preset-icon">&#128444;</div>
                            <div class="preset-name">Oil Painting</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'comic')">
                            <div class="preset-icon">&#128165;</div>
                            <div class="preset-name">Pop Art</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'vaporwave')">
                            <div class="preset-icon">&#127774;</div>
                            <div class="preset-name">Vaporwave</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'synthwave')">
                            <div class="preset-icon">&#127752;</div>
                            <div class="preset-name">Synthwave</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'ghibli')">
                            <div class="preset-icon">&#127811;</div>
                            <div class="preset-name">Ghibli</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'noir')">
                            <div class="preset-icon">&#128373;</div>
                            <div class="preset-name">Neon Noir</div>
                        </div>
                        <div class="preset-card" onclick="selectPreset(this, 'graffiti')">
                            <div class="preset-icon">&#127480;</div>
                            <div class="preset-name">Graffiti</div>
                        </div>
                    </div>
                </div>

                <div class="options-grid">
                    <div class="option-group">
                        <div class="option-label">Aspect Ratio</div>
                        <select class="option-select" id="aspectRatio">
                            <option value="1:1">1:1 (Square)</option>
                            <option value="16:9">16:9 (Landscape)</option>
                            <option value="9:16">9:16 (Portrait)</option>
                            <option value="4:3">4:3 (Standard)</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <div class="option-label">Quality</div>
                        <select class="option-select" id="quality">
                            <option value="standard">Standard</option>
                            <option value="high" selected>High</option>
                            <option value="ultra">Ultra HD</option>
                        </select>
                    </div>
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateImage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                    Generate Image
                </button>

                <div class="sample-prompts">
                    <h3 class="section-title">Sample Scene Prompts</h3>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">Just describe the background/scene - the character description, texture, lighting, and camera effects are added automatically from the template.</div>
                    <div class="sample-prompt" onclick="usePrompt(this)">
                        Smoky midnight blue with subtle volumetric fog
                    </div>
                    <div class="sample-prompt" onclick="usePrompt(this)">
                        Cozy coffee shop with morning light streaming through windows
                    </div>
                    <div class="sample-prompt" onclick="usePrompt(this)">
                        Tokyo neon cityscape at night with rain reflections
                    </div>
                    <div class="sample-prompt" onclick="usePrompt(this)">
                        Bitcoin mining rig server room with glowing LEDs
                    </div>
                    <div class="sample-prompt" onclick="usePrompt(this)">
                        Yacht club party on deck at sunset
                    </div>
                    <div class="sample-prompt" onclick="usePrompt(this)">
                        Laboratory with bubbling green serum vials
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <div class="results-header">
                    <h2 class="section-title">Generated Images</h2>
                </div>

                <div id="resultsContainer">
                    <div class="empty-results">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <h3>No images yet</h3>
                        <p>Describe the scene you want your Mutant Ape in and hit Generate</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let selectedPreset = 'realistic';
        let uploadedImage = null;  // null = use server's default Mutant Ape
        let isGenerating = false;

        function selectPreset(el, preset) {
            document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedPreset = preset;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = e.target.result;
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.classList.add('has-image');
                uploadArea.innerHTML = `
                    <img src="${uploadedImage}" class="uploaded-image" alt="Custom reference">
                    <div class="upload-text" style="margin-top: 12px;">Custom reference loaded — click to change</div>
                    <div class="upload-hint"><a href="#" onclick="resetToDefault(event)" style="color: var(--accent);">Reset to Mutant Ape</a></div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="handleFileUpload(event)">
                `;
            };
            reader.readAsDataURL(file);
        }

        function resetToDefault(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadedImage = null;
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <img src="/assets/mutant-ape/mutant_ape.png" class="uploaded-image" alt="KRAM's Mutant Ape" id="referencePreview">
                <div class="upload-text" style="margin-top: 12px;">Your Mutant Ape (auto-loaded) — click to use a different image</div>
                <div class="upload-hint">The server always references your Mutant Ape for GPT-4o analysis</div>
                <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="handleFileUpload(event)">
            `;
        }

        function usePrompt(el) {
            document.getElementById('promptInput').value = el.textContent.trim();
        }

        let generatedImages = [];

        async function generateImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('Please enter a prompt describing the image you want to create.');
                return;
            }

            if (isGenerating) return;
            isGenerating = true;

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div> Generating...';

            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Creating your image with DALL-E 3... This may take 15-30 seconds.</div>
                </div>
            `;

            const aspectRatio = document.getElementById('aspectRatio').value;
            const quality = document.getElementById('quality').value;

            // GPT-4o always analyzes the reference image (server auto-loads Mutant Ape if none sent)
            container.querySelector('.loading-text').textContent =
                'Analyzing reference image with GPT-4o, building template prompt, then generating with DALL-E 3...';

            const requestBody = {
                prompt: prompt,
                style: selectedPreset,
                aspect_ratio: aspectRatio,
                quality: quality
            };

            // Send custom reference image if user uploaded one
            // Otherwise, server auto-loads the Mutant Ape image
            if (uploadedImage) {
                requestBody.reference_image = uploadedImage;
            }

            try {
                const response = await fetch('/api/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success && data.images && data.images.length > 0) {
                    generatedImages = data.images;

                    let infoCards = '';

                    // Show vision analysis if reference image was used
                    if (data.vision_description) {
                        infoCards += `
                            <div style="margin-top: 16px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
                                <div style="font-size: 11px; color: var(--accent); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">GPT-4o Reference Analysis</div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${escapeHtml(data.vision_description)}</div>
                            </div>
                        `;
                    }

                    if (data.enhanced_prompt) {
                        infoCards += `
                            <div style="margin-top: 8px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Enhanced Prompt (sent to DALL-E)</div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${escapeHtml(data.enhanced_prompt)}</div>
                            </div>
                        `;
                    } else if (data.revised_prompt) {
                        infoCards += `
                            <div style="margin-top: 8px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">DALL-E Interpreted Prompt</div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${escapeHtml(data.revised_prompt)}</div>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div class="results-grid">
                            ${data.images.map((img, i) => `
                                <div class="result-card">
                                    <img src="${img}" class="result-image" alt="Generated image ${i + 1}" loading="lazy">
                                    <div class="result-actions">
                                        <button class="result-btn" onclick="downloadImage(${i})">Download</button>
                                        <button class="result-btn" onclick="regenerate()">Regenerate</button>
                                        <button class="result-btn primary" onclick="copyImageUrl(${i})">Copy URL</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${infoCards}
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-results">
                            <h3 style="color: var(--error);">Generation Failed</h3>
                            <p>${escapeHtml(data.error || 'Unknown error occurred')}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Image generation error:', error);
                container.innerHTML = `
                    <div class="empty-results">
                        <h3 style="color: var(--error);">Connection Error</h3>
                        <p>Could not connect to the image generation API. Please try again.</p>
                    </div>
                `;
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
                Generate Image
            `;
            isGenerating = false;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadImage(index) {
            const url = generatedImages[index];
            if (!url) return;
            // Open in new tab for download (DALL-E URLs are temporary)
            window.open(url, '_blank');
        }

        function copyImageUrl(index) {
            const url = generatedImages[index];
            if (!url) return;
            navigator.clipboard.writeText(url).then(() => {
                const btns = document.querySelectorAll('.result-btn.primary');
                if (btns[index]) {
                    btns[index].textContent = 'Copied!';
                    btns[index].style.background = 'var(--success)';
                    setTimeout(() => {
                        btns[index].textContent = 'Copy URL';
                        btns[index].style.background = '';
                    }, 2000);
                }
            });
        }

        function regenerate() {
            generateImage();
        }
    </script>
</body>
</html>
