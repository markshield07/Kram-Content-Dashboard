<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - ContentAI</title>
    <script src="/theme.js"></script>
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-card: #141414;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #f7931a;
            --accent-hover: #ffa726;
            --border: #2a2a2a;
            --success: #34c759;
            --error: #ff3b30;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo { padding: 0 20px 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .sidebar-logo h1 { font-size: 24px; font-weight: 700; }
        .sidebar-logo h1 span { color: var(--accent); }

        .nav-section { padding: 0 12px; margin-bottom: 24px; }
        .nav-section-title { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); padding: 0 8px; margin-bottom: 8px; letter-spacing: 0.5px; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: 8px; color: var(--text-secondary); text-decoration: none;
            transition: all 0.2s; cursor: pointer; font-size: 14px;
        }
        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: rgba(247, 147, 26, 0.1); color: var(--accent); }
        .nav-item svg { width: 20px; height: 20px; }

        /* Main Content */
        .main-content { flex: 1; margin-left: 250px; }

        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 30px; border-bottom: 1px solid var(--border); background: var(--bg-secondary);
        }
        .page-title { font-size: 24px; font-weight: 600; }
        .header-actions { display: flex; gap: 12px; align-items: center; }

        .btn {
            padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; text-decoration: none; border: none;
        }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { background: var(--accent-hover); }

        /* Platform Tabs */
        .platform-tabs {
            display: flex; gap: 8px; padding: 20px 30px;
            background: var(--bg-secondary); border-bottom: 1px solid var(--border);
        }
        .platform-tab {
            display: flex; align-items: center; gap: 8px; padding: 10px 20px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .platform-tab:hover { border-color: var(--accent); }
        .platform-tab.active { background: rgba(247, 147, 26, 0.1); border-color: var(--accent); color: var(--accent); }
        .platform-tab svg { width: 18px; height: 18px; fill: currentColor; }
        .platform-tab.not-connected { opacity: 0.5; }
        .platform-tab .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
        .platform-tab.not-connected .status-dot { background: var(--text-secondary); }

        /* Date Range Filter */
        .date-filter-bar {
            display: flex; gap: 8px; padding: 16px 30px;
            background: var(--bg-primary); border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .date-filter-label {
            font-size: 13px; color: var(--text-secondary); margin-right: 8px; font-weight: 500;
        }
        .date-chip {
            padding: 8px 18px; border-radius: 20px; font-size: 13px; font-weight: 500;
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary);
            cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .date-chip:hover { border-color: var(--accent); color: var(--text-primary); }
        .date-chip.active {
            background: rgba(247, 147, 26, 0.15); border-color: var(--accent); color: var(--accent);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 20px; padding: 30px;
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px;
        }
        .stat-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 600; }
        .stat-change { font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--error); }
        .stat-change.neutral { color: var(--text-secondary); }

        /* Content Area */
        .content-area { padding: 0 30px 30px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }

        /* Two-column layout for posts */
        .posts-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px;
        }

        /* Recent Posts */
        .posts-section {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;
        }
        .posts-section-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 20px 16px; border-bottom: 1px solid var(--border);
        }
        .posts-section-header h2 { font-size: 16px; font-weight: 600; }
        .posts-section-header .post-count {
            font-size: 12px; color: var(--text-secondary); background: var(--bg-secondary);
            padding: 4px 10px; border-radius: 12px;
        }
        .posts-list {
            flex: 1; max-height: 520px; overflow-y: auto;
        }
        .posts-list::-webkit-scrollbar { width: 6px; }
        .posts-list::-webkit-scrollbar-track { background: transparent; }
        .posts-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .posts-list::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        .post-item {
            display: flex; align-items: flex-start; gap: 14px;
            padding: 16px 20px; border-bottom: 1px solid var(--border); transition: background 0.2s;
        }
        .post-item:last-child { border-bottom: none; }
        .post-item:hover { background: var(--bg-secondary); }

        .post-rank {
            width: 28px; height: 28px; background: var(--bg-secondary); border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 13px; color: var(--accent); flex-shrink: 0;
        }
        .post-rank.gold { background: rgba(247, 147, 26, 0.2); }
        .post-rank.silver { background: rgba(160, 160, 160, 0.15); color: #c0c0c0; }
        .post-rank.bronze { background: rgba(205, 127, 50, 0.15); color: #cd7f32; }

        .post-content { flex: 1; min-width: 0; }
        .post-text {
            font-size: 13px; line-height: 1.5; margin-bottom: 10px;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
            overflow: hidden; word-break: break-word;
        }
        .post-metrics { display: flex; gap: 16px; flex-wrap: wrap; }
        .post-metric {
            display: flex; align-items: center; gap: 5px;
            font-size: 12px; color: var(--text-secondary);
        }
        .post-metric svg { width: 14px; height: 14px; }
        .post-date { font-size: 11px; color: var(--text-secondary); white-space: nowrap; flex-shrink: 0; margin-top: 2px; }

        /* Charts Section */
        .chart-section {
            display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 30px;
        }
        .chart-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px;
        }
        .chart-card .section-title { margin-bottom: 20px; }

        .chart-container { position: relative; width: 100%; height: 280px; }
        .chart-container canvas { width: 100% !important; height: 100% !important; }

        /* Best Times Heatmap */
        .heatmap-wrapper { margin-top: 12px; }
        .heatmap-row {
            display: grid; grid-template-columns: 70px repeat(7, 1fr); gap: 4px;
            margin-bottom: 4px; align-items: center;
        }
        .heatmap-time-label {
            font-size: 11px; color: var(--text-secondary); text-align: right; padding-right: 8px;
        }
        .heatmap-day-labels {
            display: grid; grid-template-columns: 70px repeat(7, 1fr); gap: 4px; margin-bottom: 8px;
        }
        .heatmap-day-label { font-size: 11px; color: var(--text-secondary); text-align: center; font-weight: 500; }
        .heatmap-cell {
            height: 28px; border-radius: 4px; background: var(--bg-secondary);
            transition: background 0.2s; position: relative;
        }
        .heatmap-cell[title] { cursor: default; }
        .heatmap-cell.intensity-1 { background: rgba(247, 147, 26, 0.15); }
        .heatmap-cell.intensity-2 { background: rgba(247, 147, 26, 0.3); }
        .heatmap-cell.intensity-3 { background: rgba(247, 147, 26, 0.5); }
        .heatmap-cell.intensity-4 { background: rgba(247, 147, 26, 0.7); }
        .heatmap-cell.intensity-5 { background: var(--accent); }
        .heatmap-legend {
            display: flex; align-items: center; gap: 6px; margin-top: 12px;
            justify-content: flex-end;
        }
        .heatmap-legend span { font-size: 11px; color: var(--text-secondary); }
        .legend-cell {
            width: 16px; height: 16px; border-radius: 3px;
        }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state svg { width: 64px; height: 64px; color: var(--text-secondary); margin-bottom: 20px; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; }
        .empty-state p { color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; }

        /* Loading spinner */
        .loading-spinner {
            display: flex; align-items: center; justify-content: center;
            padding: 40px; color: var(--text-secondary); font-size: 14px; gap: 12px;
        }
        .spinner {
            width: 20px; height: 20px; border: 2px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1200px) {
            .posts-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-section { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; padding: 20px; }
            .platform-tabs { overflow-x: auto; padding: 15px 20px; }
            .date-filter-bar { overflow-x: auto; padding: 12px 20px; }
            .content-area { padding: 0 20px 20px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <h1>Content<span>AI</span></h1>
        </div>

        <div class="nav-section">
            <a href="/dashboard" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Dashboard
            </a>
            <a href="/analytics" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"></path><path d="M12 20V4"></path><path d="M6 20v-6"></path></svg>
                Analytics
            </a>
            <a href="/generate" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M20 12a8 8 0 0 0-8-8v8h8z"></path></svg>
                Generate Content
            </a>
            <a href="/images" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Image Generator
            </a>
            <a href="/calendar" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Calendar
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Tools</div>
            <a href="/ab-testing" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
                A/B Testing
            </a>
            <a href="/reply-bot" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                Reply Bot
            </a>
            <a href="/trends" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                Trends
            </a>
            <a href="/competitors" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Competitors
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Account</div>
            <a href="/settings" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Settings
            </a>
            <a href="/api/logout" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                Logout
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header class="top-header">
            <h1 class="page-title">Analytics</h1>
            <div class="header-actions">
                <button id="themeToggle" onclick="toggleTheme()" title="Toggle theme" style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer;color:var(--text-primary);display:flex;align-items:center;transition:all 0.2s;"></button>
                <button class="btn btn-primary" onclick="refreshAnalytics()">Refresh Data</button>
            </div>
        </header>

        <!-- Platform Tabs -->
        <div class="platform-tabs">
            <div class="platform-tab active" onclick="selectPlatform('x', this)">
                <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                X / Twitter
                <span class="status-dot"></span>
            </div>
            <div class="platform-tab not-connected" onclick="selectPlatform('instagram', this)">
                <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                Instagram
                <span class="status-dot"></span>
            </div>
            <div class="platform-tab not-connected" onclick="selectPlatform('facebook', this)">
                <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                Facebook
                <span class="status-dot"></span>
            </div>
            <div class="platform-tab not-connected" onclick="selectPlatform('tiktok', this)">
                <svg viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>
                TikTok
                <span class="status-dot"></span>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="date-filter-bar">
            <span class="date-filter-label">Date Range:</span>
            <div class="date-chip" data-range="1d" onclick="selectDateRange('1d', this)">1 Day</div>
            <div class="date-chip active" data-range="7d" onclick="selectDateRange('7d', this)">7 Days</div>
            <div class="date-chip" data-range="1m" onclick="selectDateRange('1m', this)">1 Month</div>
            <div class="date-chip" data-range="3m" onclick="selectDateRange('3m', this)">3 Months</div>
            <div class="date-chip" data-range="1y" onclick="selectDateRange('1y', this)">1 Year</div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">Total Followers</div>
                <div class="stat-value" id="totalFollowers">--</div>
                <div class="stat-change neutral" id="followersChange">Current count</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Engagement</div>
                <div class="stat-value" id="totalEngagement">--</div>
                <div class="stat-change neutral" id="engagementChange">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg. Likes/Post</div>
                <div class="stat-value" id="avgLikes">--</div>
                <div class="stat-change neutral" id="avgLikesChange">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Impressions</div>
                <div class="stat-value" id="totalImpressions">--</div>
                <div class="stat-change neutral" id="impressionsChange">--</div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Posts Grid: Recent + Top Performing side by side -->
            <div class="posts-grid">
                <!-- Recent Posts -->
                <div class="posts-section">
                    <div class="posts-section-header">
                        <h2>Recent Posts</h2>
                        <span class="post-count" id="recentPostCount">0 posts</span>
                    </div>
                    <div class="posts-list" id="recentPosts">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            Loading posts...
                        </div>
                    </div>
                </div>

                <!-- Top Performing Tweets -->
                <div class="posts-section">
                    <div class="posts-section-header">
                        <h2>Top Performing Tweets</h2>
                        <span class="post-count">Top 5</span>
                    </div>
                    <div class="posts-list" id="topPosts">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            Loading top posts...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="chart-section">
                <div class="chart-card">
                    <h3 class="section-title">Engagement Over Time</h3>
                    <div class="chart-container">
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="section-title">Best Times to Post</h3>
                    <div class="heatmap-wrapper" id="heatmapWrapper">
                        <!-- Heatmap rendered by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ========== State ==========
        let allTweets = [];
        let filteredTweets = [];
        let profileData = null;
        let currentRange = '7d';

        const ranges = {
            '1d': 1,
            '7d': 7,
            '1m': 30,
            '3m': 90,
            '1y': 365
        };

        // ========== Platform Selection ==========
        function selectPlatform(platform, el) {
            document.querySelectorAll('.platform-tab').forEach(tab => tab.classList.remove('active'));
            el.classList.add('active');

            if (el.classList.contains('not-connected')) {
                alert('This platform is not connected yet. Go to Settings to connect your account.');
                return;
            }

            refreshAnalytics();
        }

        // ========== Date Range Selection ==========
        function selectDateRange(range, el) {
            currentRange = range;
            document.querySelectorAll('.date-chip').forEach(chip => chip.classList.remove('active'));
            el.classList.add('active');
            applyFiltersAndRender();
        }

        // ========== Date Filtering ==========
        function filterByRange(tweets, days) {
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            return tweets.filter(t => new Date(t.created_at) >= cutoff);
        }

        function getPreviousPeriodTweets(tweets, days) {
            const now = new Date();
            const currentCutoff = new Date();
            currentCutoff.setDate(now.getDate() - days);
            const previousCutoff = new Date();
            previousCutoff.setDate(now.getDate() - (days * 2));
            return tweets.filter(t => {
                const d = new Date(t.created_at);
                return d >= previousCutoff && d < currentCutoff;
            });
        }

        // ========== Metric Calculations ==========
        function getTweetEngagement(tweet) {
            const m = tweet.metrics || {};
            return (m.like_count || 0) + (m.retweet_count || 0) + (m.reply_count || 0);
        }

        function getTweetImpressions(tweet) {
            const m = tweet.metrics || {};
            if (m.impression_count && m.impression_count > 0) return m.impression_count;
            // Proxy: likes + retweets * 3
            return (m.like_count || 0) + (m.retweet_count || 0) * 3;
        }

        function calcTotalEngagement(tweets) {
            return tweets.reduce((sum, t) => sum + getTweetEngagement(t), 0);
        }

        function calcAvgLikes(tweets) {
            if (tweets.length === 0) return 0;
            const totalLikes = tweets.reduce((sum, t) => sum + ((t.metrics || {}).like_count || 0), 0);
            return totalLikes / tweets.length;
        }

        function calcTotalImpressions(tweets) {
            return tweets.reduce((sum, t) => sum + getTweetImpressions(t), 0);
        }

        function calcChangePercent(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous) * 100;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function renderChangeIndicator(elementId, percent) {
            const el = document.getElementById(elementId);
            if (isNaN(percent) || !isFinite(percent)) {
                el.className = 'stat-change neutral';
                el.textContent = 'No prior data';
                return;
            }
            const rounded = Math.abs(percent).toFixed(1);
            if (percent > 0) {
                el.className = 'stat-change positive';
                el.innerHTML = '\u2191 ' + rounded + '% vs prior period';
            } else if (percent < 0) {
                el.className = 'stat-change negative';
                el.innerHTML = '\u2193 ' + rounded + '% vs prior period';
            } else {
                el.className = 'stat-change neutral';
                el.textContent = 'No change vs prior period';
            }
        }

        // ========== Stats Rendering ==========
        function renderStats() {
            const days = ranges[currentRange];
            const currentTweets = filteredTweets;
            const previousTweets = getPreviousPeriodTweets(allTweets, days);

            // Followers (stays the same regardless of date filter)
            if (profileData) {
                const followers = (profileData.metrics || {}).followers_count || 0;
                document.getElementById('totalFollowers').textContent = formatNumber(followers);
                document.getElementById('followersChange').className = 'stat-change neutral';
                document.getElementById('followersChange').textContent = 'Current count';
            }

            // Total Engagement
            const currentEngagement = calcTotalEngagement(currentTweets);
            const previousEngagement = calcTotalEngagement(previousTweets);
            document.getElementById('totalEngagement').textContent = formatNumber(currentEngagement);
            renderChangeIndicator('engagementChange', calcChangePercent(currentEngagement, previousEngagement));

            // Avg Likes/Post
            const currentAvgLikes = calcAvgLikes(currentTweets);
            const previousAvgLikes = calcAvgLikes(previousTweets);
            document.getElementById('avgLikes').textContent = currentAvgLikes.toFixed(1);
            renderChangeIndicator('avgLikesChange', calcChangePercent(currentAvgLikes, previousAvgLikes));

            // Impressions
            const currentImpressions = calcTotalImpressions(currentTweets);
            const previousImpressions = calcTotalImpressions(previousTweets);
            document.getElementById('totalImpressions').textContent = formatNumber(currentImpressions);
            renderChangeIndicator('impressionsChange', calcChangePercent(currentImpressions, previousImpressions));
        }

        // ========== SVG Icons for Post Metrics ==========
        const iconHeart = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>';
        const iconRetweet = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>';
        const iconReply = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>';
        const iconEye = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';

        function renderPostItem(tweet, index, showRank) {
            const m = tweet.metrics || {};
            const likes = m.like_count || 0;
            const retweets = m.retweet_count || 0;
            const replies = m.reply_count || 0;
            const impressions = getTweetImpressions(tweet);
            const dateStr = tweet.created_at ? new Date(tweet.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
            const text = (tweet.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            let rankClass = '';
            if (showRank) {
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
            }

            return '<div class="post-item">' +
                (showRank ? '<div class="post-rank ' + rankClass + '">' + (index + 1) + '</div>' : '') +
                '<div class="post-content">' +
                    '<div class="post-text">' + text + '</div>' +
                    '<div class="post-metrics">' +
                        '<span class="post-metric">' + iconHeart + ' ' + formatNumber(likes) + '</span>' +
                        '<span class="post-metric">' + iconRetweet + ' ' + formatNumber(retweets) + '</span>' +
                        '<span class="post-metric">' + iconReply + ' ' + formatNumber(replies) + '</span>' +
                        '<span class="post-metric">' + iconEye + ' ' + formatNumber(impressions) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="post-date">' + dateStr + '</div>' +
            '</div>';
        }

        // ========== Recent Posts ==========
        function renderRecentPosts() {
            const container = document.getElementById('recentPosts');
            const countEl = document.getElementById('recentPostCount');

            // Sort by date descending (newest first)
            const sorted = [...filteredTweets].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            countEl.textContent = sorted.length + ' post' + (sorted.length !== 1 ? 's' : '');

            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No posts in this period</h3><p>Try selecting a wider date range.</p></div>';
                return;
            }

            container.innerHTML = sorted.map((t, i) => renderPostItem(t, i, false)).join('');
        }

        // ========== Top Performing ==========
        function renderTopPosts() {
            const container = document.getElementById('topPosts');

            // Sort by engagement score descending
            const sorted = [...filteredTweets].sort((a, b) => {
                const scoreA = getTweetEngagement(a);
                const scoreB = getTweetEngagement(b);
                return scoreB - scoreA;
            });

            const top5 = sorted.slice(0, 5);

            if (top5.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No posts in this period</h3><p>Try selecting a wider date range.</p></div>';
                return;
            }

            container.innerHTML = top5.map((t, i) => renderPostItem(t, i, true)).join('');
        }

        // ========== Engagement Chart (Canvas) ==========
        function renderEngagementChart() {
            const canvas = document.getElementById('engagementChart');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);

            const W = rect.width;
            const H = rect.height;

            // Clear
            ctx.clearRect(0, 0, W, H);

            // Group tweets by day
            const days = ranges[currentRange];
            const dailyData = {};
            const now = new Date();

            // Create empty buckets for each day in range
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(now.getDate() - i);
                const key = d.toISOString().split('T')[0];
                dailyData[key] = 0;
            }

            // Fill with actual engagement data
            filteredTweets.forEach(t => {
                if (!t.created_at) return;
                const key = new Date(t.created_at).toISOString().split('T')[0];
                if (dailyData.hasOwnProperty(key)) {
                    dailyData[key] += getTweetEngagement(t);
                }
            });

            const labels = Object.keys(dailyData);
            const values = Object.values(dailyData);
            const maxVal = Math.max(...values, 1);

            if (labels.length === 0) {
                ctx.fillStyle = '#a0a0a0';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data to display', W / 2, H / 2);
                return;
            }

            // Chart dimensions
            const padLeft = 50;
            const padRight = 20;
            const padTop = 20;
            const padBottom = 50;
            const chartW = W - padLeft - padRight;
            const chartH = H - padTop - padBottom;

            // Draw Y-axis grid lines
            ctx.strokeStyle = '#2a2a2a';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#a0a0a0';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.textAlign = 'right';

            const ySteps = 5;
            for (let i = 0; i <= ySteps; i++) {
                const y = padTop + (chartH / ySteps) * i;
                const val = Math.round(maxVal - (maxVal / ySteps) * i);
                ctx.beginPath();
                ctx.moveTo(padLeft, y);
                ctx.lineTo(W - padRight, y);
                ctx.stroke();
                ctx.fillText(formatNumber(val), padLeft - 8, y + 4);
            }

            // Determine bar display: if too many days, aggregate or limit labels
            const maxBars = Math.min(labels.length, 60);
            const step = Math.max(1, Math.floor(labels.length / maxBars));
            const displayLabels = [];
            const displayValues = [];

            if (step > 1) {
                // Aggregate into buckets
                for (let i = 0; i < labels.length; i += step) {
                    let sum = 0;
                    let count = 0;
                    for (let j = i; j < Math.min(i + step, labels.length); j++) {
                        sum += values[j];
                        count++;
                    }
                    displayLabels.push(labels[i]);
                    displayValues.push(sum);
                }
            } else {
                labels.forEach((l, i) => { displayLabels.push(l); displayValues.push(values[i]); });
            }

            const displayMax = Math.max(...displayValues, 1);
            const barCount = displayLabels.length;
            const barGap = Math.max(2, Math.min(6, chartW / barCount * 0.2));
            const barWidth = Math.max(2, (chartW - barGap * (barCount + 1)) / barCount);

            // Draw bars
            displayValues.forEach((val, i) => {
                const barH = (val / displayMax) * chartH;
                const x = padLeft + barGap + i * (barWidth + barGap);
                const y = padTop + chartH - barH;

                // Bar gradient
                const grad = ctx.createLinearGradient(x, y, x, padTop + chartH);
                grad.addColorStop(0, '#f7931a');
                grad.addColorStop(1, 'rgba(247, 147, 26, 0.3)');
                ctx.fillStyle = grad;

                // Rounded top
                const radius = Math.min(3, barWidth / 2);
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + barWidth - radius, y);
                ctx.quadraticCurveTo(x + barWidth, y, x + barWidth, y + radius);
                ctx.lineTo(x + barWidth, padTop + chartH);
                ctx.lineTo(x, padTop + chartH);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
                ctx.fill();
            });

            // Draw X-axis labels (show a subset to avoid overlap)
            ctx.fillStyle = '#a0a0a0';
            ctx.font = '10px -apple-system, sans-serif';
            ctx.textAlign = 'center';

            const maxLabelsShown = Math.min(barCount, Math.floor(chartW / 60));
            const labelStep = Math.max(1, Math.ceil(barCount / maxLabelsShown));

            displayLabels.forEach((label, i) => {
                if (i % labelStep !== 0 && i !== barCount - 1) return;
                const x = padLeft + barGap + i * (barWidth + barGap) + barWidth / 2;
                const d = new Date(label + 'T00:00:00');
                const short = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                ctx.save();
                ctx.translate(x, padTop + chartH + 14);
                if (barCount > 14) {
                    ctx.rotate(-0.5);
                }
                ctx.fillText(short, 0, 0);
                ctx.restore();
            });
        }

        // ========== Best Times Heatmap ==========
        function renderHeatmap() {
            const wrapper = document.getElementById('heatmapWrapper');
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const timeBlocks = [
                { label: '6AM-9AM', start: 6, end: 9 },
                { label: '9AM-12PM', start: 9, end: 12 },
                { label: '12PM-3PM', start: 12, end: 15 },
                { label: '3PM-6PM', start: 15, end: 18 },
                { label: '6PM-9PM', start: 18, end: 21 },
                { label: '9PM-12AM', start: 21, end: 24 }
            ];

            // Build engagement matrix: [timeBlock][dayOfWeek]
            const matrix = Array.from({ length: timeBlocks.length }, () => Array(7).fill(0));

            filteredTweets.forEach(t => {
                if (!t.created_at) return;
                const d = new Date(t.created_at);
                let dow = d.getDay(); // 0=Sun ... 6=Sat
                dow = dow === 0 ? 6 : dow - 1; // Convert to Mon=0 ... Sun=6
                const hour = d.getHours();
                const engagement = getTweetEngagement(t);

                for (let bi = 0; bi < timeBlocks.length; bi++) {
                    if (hour >= timeBlocks[bi].start && hour < timeBlocks[bi].end) {
                        matrix[bi][dow] += engagement;
                        break;
                    }
                }
            });

            // Find max for intensity scaling
            let maxEng = 0;
            matrix.forEach(row => row.forEach(val => { if (val > maxEng) maxEng = val; }));

            function getIntensity(val) {
                if (maxEng === 0 || val === 0) return 0;
                const pct = val / maxEng;
                if (pct >= 0.8) return 5;
                if (pct >= 0.6) return 4;
                if (pct >= 0.4) return 3;
                if (pct >= 0.2) return 2;
                return 1;
            }

            // Build HTML
            let html = '';

            // Day labels row
            html += '<div class="heatmap-day-labels">';
            html += '<div></div>'; // spacer for time column
            dayNames.forEach(d => { html += '<div class="heatmap-day-label">' + d + '</div>'; });
            html += '</div>';

            // Time block rows
            timeBlocks.forEach((block, bi) => {
                html += '<div class="heatmap-row">';
                html += '<div class="heatmap-time-label">' + block.label + '</div>';
                for (let di = 0; di < 7; di++) {
                    const intensity = getIntensity(matrix[bi][di]);
                    const engVal = matrix[bi][di];
                    html += '<div class="heatmap-cell intensity-' + intensity + '" title="' + dayNames[di] + ' ' + block.label + ': ' + engVal + ' engagement"></div>';
                }
                html += '</div>';
            });

            // Legend
            html += '<div class="heatmap-legend">';
            html += '<span>Less</span>';
            html += '<div class="legend-cell" style="background: var(--bg-secondary);"></div>';
            html += '<div class="legend-cell" style="background: rgba(247, 147, 26, 0.15);"></div>';
            html += '<div class="legend-cell" style="background: rgba(247, 147, 26, 0.3);"></div>';
            html += '<div class="legend-cell" style="background: rgba(247, 147, 26, 0.5);"></div>';
            html += '<div class="legend-cell" style="background: rgba(247, 147, 26, 0.7);"></div>';
            html += '<div class="legend-cell" style="background: var(--accent);"></div>';
            html += '<span>More</span>';
            html += '</div>';

            wrapper.innerHTML = html;
        }

        // ========== Apply Filters & Re-render Everything ==========
        function applyFiltersAndRender() {
            const days = ranges[currentRange];
            filteredTweets = filterByRange(allTweets, days);

            renderStats();
            renderRecentPosts();
            renderTopPosts();
            renderEngagementChart();
            renderHeatmap();
        }

        // ========== Main Data Fetch ==========
        async function refreshAnalytics() {
            const recentContainer = document.getElementById('recentPosts');
            const topContainer = document.getElementById('topPosts');

            recentContainer.innerHTML = '<div class="loading-spinner"><div class="spinner"></div>Loading posts...</div>';
            topContainer.innerHTML = '<div class="loading-spinner"><div class="spinner"></div>Loading top posts...</div>';

            // Reset stat values while loading
            document.getElementById('totalFollowers').textContent = '--';
            document.getElementById('totalEngagement').textContent = '--';
            document.getElementById('avgLikes').textContent = '--';
            document.getElementById('totalImpressions').textContent = '--';

            try {
                // Fetch tweets
                const tweetsRes = await fetch('/api/tweets?max_results=100');

                if (tweetsRes.status === 401) {
                    const errorHtml = '<div class="empty-state">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"></path><path d="M12 20V4"></path><path d="M6 20v-6"></path></svg>' +
                        '<h3>Session expired</h3>' +
                        '<p>Your X session may have expired. Access tokens last 2 hours. Please sign in again.</p>' +
                        '<a href="/api/login" class="btn btn-primary">Sign In Again</a>' +
                        '</div>';
                    recentContainer.innerHTML = errorHtml;
                    topContainer.innerHTML = errorHtml;
                    return;
                }

                const tweetsText = await tweetsRes.text();
                let data;
                try {
                    data = JSON.parse(tweetsText);
                } catch (parseErr) {
                    console.error('Failed to parse tweets response:', tweetsText);
                    throw new Error('Invalid response from tweets API');
                }

                if (!tweetsRes.ok) {
                    console.error('Tweets API error:', data);
                    throw new Error(data.error || 'Failed to load tweets');
                }

                allTweets = data.tweets || [];

                // Fetch profile separately
                try {
                    const profileRes = await fetch('/api/profile');
                    if (profileRes.ok) {
                        profileData = await profileRes.json();
                    }
                } catch (profileErr) {
                    console.warn('Could not load profile:', profileErr);
                }

                // Apply current date filter and render everything
                applyFiltersAndRender();

            } catch (error) {
                console.error('Analytics error:', error);
                const errorHtml = '<div class="empty-state">' +
                    '<h3>Error loading analytics</h3>' +
                    '<p>' + (error.message || 'Please try again later.') + '</p>' +
                    '<p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">Try <a href="/api/login" style="color: var(--accent);">signing in again</a> if your session expired.</p>' +
                    '<button class="btn btn-primary" onclick="refreshAnalytics()" style="margin-top: 16px;">Retry</button>' +
                    '</div>';
                recentContainer.innerHTML = errorHtml;
                topContainer.innerHTML = errorHtml;
            }
        }

        // ========== Resize handler for chart ==========
        let resizeTimer;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                if (filteredTweets.length > 0) {
                    renderEngagementChart();
                }
            }, 250);
        });

        // ========== Init ==========
        document.addEventListener('DOMContentLoaded', refreshAnalytics);
    </script>
</body>
</html>
